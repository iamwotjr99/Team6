<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<h2>ì±„íŒ…ë°© í…ŒìŠ¤íŠ¸</h2>

<!-- ìœ ì € ì •ë³´ ì…ë ¥ -->
<div>
  <input type="text" id="senderIdInput" placeholder="ìœ ì € ID ì…ë ¥" />
  <input type="text" id="senderNameInput" placeholder="ìœ ì € ì´ë¦„ ì…ë ¥" />
</div>

<!-- ì±„íŒ…ë°© ë²ˆí˜¸ ì…ë ¥ -->
<div style="margin-top: 10px;">
  <input type="text" id="roomIdInput" placeholder="ì±„íŒ…ë°© ID ì…ë ¥" />
  <button onclick="connect()">ì…ì¥í•˜ê¸°</button>
</div>

<!-- ë©”ì‹œì§€ ì…ë ¥ -->
<div style="margin-top: 10px;">
  <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
  <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<!-- ë‚˜ê°€ê¸° -->
<div style="margin-top: 10px;">
  <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
  <button onclick="leaveRoom()">ì±„íŒ…ë°© í‡´ì¥ (LEAVE)</button>
</div>

<ul id="messages" style="margin-top: 20px;"></ul>

<script>
  let stompClient = null;
  let connectedRoomId = null;
  let messageMap = {}; // ë©”ì‹œì§€ ID -> DOM element ë§¤í•‘

  function connect() {
    const senderId = document.getElementById('senderIdInput').value;
    const senderName = document.getElementById('senderNameInput').value;
    const roomId = document.getElementById('roomIdInput').value;

    if (stompClient) {
      stompClient.disconnect(() => {
        console.log('ê¸°ì¡´ ì—°ê²° í•´ì œë¨');
      });
    }

    if (!senderId || !senderName || !roomId) {
      alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    connectedRoomId = roomId;

    const socket = new SockJS(`http://localhost:8080/ws-stomp?userId=${senderId}&roomId=${roomId}`);
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function () {
      console.log('STOMP ì—°ê²° ì„±ê³µ');

      // 1. ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ 
      stompClient.subscribe(`/sub/chatroom/${roomId}`, function (message) {
        const msg = JSON.parse(message.body);
        showMessage(msg);
      });

      // 2. ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
      stompClient.subscribe(`/sub/chatroom/${roomId}/read-update`, function (message) {
        const updates = JSON.parse(message.body);
        if (Array.isArray(updates)) {
          updates.forEach(updateUnreadCount);
        } else {
          updateUnreadCount(updates);
        }
      });

      // 3. ENTER ë©”ì‹œì§€ ì „ì†¡
      stompClient.send(`/pub/chatroom/${roomId}/enter`, {}, JSON.stringify({
        senderId: Number(senderId),
        senderName: senderName,
        content: '',
        messageType: 'TEXT',
        eventType: 'ENTER'
      }));

      // 4. ìœ ì € ì „ìš© unread summary êµ¬ë…
      stompClient.subscribe(`/sub/user/${senderId}/unread-summary`, function (message) {
        const payload = JSON.parse(message.body);
        alert(`ğŸ“¨ [ì±„íŒ…ë°© ${payload.roomId}] ì•ˆì½ì€ ë©”ì‹œì§€: ${payload.unreadCount}`);
      });

      // 5. ê¸°ì¡´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
      fetch(`http://localhost:8080/api/dev/chatroom/${roomId}/messages?userId=${senderId}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('messages').innerHTML = '';
        data.data.forEach(showMessage);
      })
      .catch(err => console.error('ê¸°ì¡´ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨', err));
    });
  }

  function sendMessage() {
    const senderId = document.getElementById('senderIdInput').value;
    const senderName = document.getElementById('senderNameInput').value;
    const message = document.getElementById('messageInput').value;

    if (!stompClient || !connectedRoomId || !message) return;

    stompClient.send(`/pub/chatroom/${connectedRoomId}`, {}, JSON.stringify({
      senderId: Number(senderId),
      senderName: senderName,
      content: message,
      messageType: 'TEXT',
      eventType: 'NONE'
    }));

    document.getElementById('messageInput').value = '';
  }

  function leaveRoom() {
    const senderId = document.getElementById('senderIdInput').value;
    const senderName = document.getElementById('senderNameInput').value;

    if (!stompClient || !connectedRoomId) return;

    stompClient.send(`/pub/chatroom/${connectedRoomId}/leave`, {}, JSON.stringify({
      senderId: Number(senderId),
      senderName: senderName,
      content: '',
      messageType: 'TEXT',
      eventType: 'LEAVE'
    }));

    stompClient.disconnect(() => {
      console.log('í‡´ì¥ ë° ì—°ê²° í•´ì œë¨');
    });
  }

  function disconnect() {
    if (stompClient) {
      stompClient.disconnect(() => {
        console.log('ì—°ê²° í•´ì œë¨');
      });
    }
  }

  function showMessage(message) {
    const ul = document.getElementById('messages');
    const li = document.createElement('li');
    li.id = `msg-${message.id}`; // ë©”ì‹œì§€ ID ê¸°ë°˜
    li.innerHTML = `<strong>${message.senderName}:</strong> ${message.content}
      <span class="unread-count">(${message.unreadCount ?? 0}ëª… ì•ˆì½ìŒ)</span><br>
      <small>${message.createdAt}</small>`;
    ul.appendChild(li);

    messageMap[String(message.id)] = li; // ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ ìœ„í•´ ì €ì¥
  }

  function updateUnreadCount(update) {
    const messageId = String(update.messageId);
    const unreadCount = update.unreadCount;

    const li = messageMap[messageId];
    console.log("ğŸ”¥ update messageId:", messageId);
    console.log("ğŸ“Œ messageMap keys:", Object.keys(messageMap));
    if (li) {
      const span = li.querySelector('.unread-count');
      if (span) {
        span.textContent = `(${unreadCount}ëª… ì•ˆì½ìŒ)`;
      }
    }
  }
</script>


</body>
</html>
